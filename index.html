<!DOCTYPE html>
<html>

<head>
    <title>2024 Malaysia Population Statistics Visualization</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: sans-serif;
            background-color: #FDFDFD;
            /* 16进制颜色代码:浅灰,比#FFFFFF更柔和 */
            margin: 0;
            /* 外边距 */
            padding: 1rem;
            /* 内边距 */
        }

        .vega-bindings {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: nowrap;
            justify-content: center;
            margin-bottom: 8px;
        }

        .vega-bindings label {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .vega-bindings select {
            padding: 2px 6px;
            height: 32px;
        }

        .dashboard-container {
            border: 1px solid #E0E0E0;
            background: #FFFFFF;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        #static-dashboard {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-top: 1rem;
        }

        .chart-container {
            border: 1px solid #E0E0E0;
            background: #F9F9F9;
        }
		
		/* 小屏及以下 */
		@media (max-width: 575.98px) {
			.vega-bindings {
				display: flex;
				gap: 12px;
				align-items: center;
				flex-wrap: wrap;
				justify-content: center;
				margin-bottom: 8px;
			}
			#space {
				height: 90px;
			}
		}

		/* 中等及以上屏幕 */
		@media (min-width: 768px) {
			.vega-bindings {
				display: flex;
				gap: 12px;
				align-items: center;
				flex-wrap: nowrap;
				justify-content: center;
				margin-bottom: 8px;
			}
		}

        footer {
            margin-top: 2rem;
            padding: 1rem;
            border-top: 1px solid #E0E0E0;
            text-align: center;
            color: #666;
        }
    </style>
</head>

<body class="container">
    <div style="text-align: center; border-bottom: 1px solid black; margin-bottom: 0.5rem;">
        <h1 style="margin: 0.5rem;">2024 Malaysia Population Statistics Visualization</h1>
    </div>

    <div style="border: 1px solid gray; background: #F9F9F9; border-radius: 0.5rem; padding: 0.5rem; margin-bottom: 0.5rem;">
        Demographics are a very important statistical indicator for a country or region. This website uses Vega-Lite to visualize the population data of various districts in Malaysia with a Choropleth map, aiming to intuitively display the population of each district through spatial visualization. At the same time, we can use the dropdown menu to select different values to explore changes in population across the three dimensions of sex, age, and ethnicity.
    </div>

    <div id="vis" style="text-align: center; width: 100%; height: 70vh; background: lightblue; border-radius: 0.5rem;"></div>
	<div id="space"></div>
    <div id="data-stats" style="margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px;"></div>

    <div class="dashboard-container">
        <div style="text-align: center;">
            <h2 style="margin: 0.5rem;">Competitors</h2>
        </div>
		
		<hr>

        <div>
            <div class="gx-1 gy-3 row">
				<!-- 第一行: 左图右文 (Stacked Bar Chart) -->
				
                <div class="card p-4 col-12 col-sm-6 col-md-6 chart-container">
					<div id="stacked-bar-chart" style="height: 40vh;"></div>
				</div>
                <div class="card p-4 col-12 col-sm-6 col-md-6">
                    <h3>Stacked Bar Chart</h3>
					<hr>
                    <p>
                        This chart visually illustrates the total population of each Malaysian state and its internal ethnic composition.
                    </p>
                    <ul>
                        <li>Each bar represents a state. The total length of the bar indicates the state's total population.</li>
                        <li>Color segments denote different ethnicities, with segment length reflecting the population size of that ethnicity within the state.</li>
                        <li>The chart is sorted in descending order by total population, with the most populous states like Selangor and Johor at the top.</li>
                    </ul>
                </div>

				<!-- 第二行: 右图左文 (Donut Chart) -->

                <div class="col-12 col-sm-6 col-md-6 card p-4"style="text-align: justify;">
                    <h3>Donut Chart</h3>
					<hr>
                    <p>
                        This pie chart illustrates the proportion of Malaysia's national population across different ethnic groups in 2024, providing a quick overview of the country's primary ethnic composition.
                    </p>
                    <p>
                        Each sector in the chart represents an ethnic group, with the sector's angle (area) proportional to its population share of the total population. Hovering your mouse over any sector displays the specific population count for that ethnic group. It's easy to see at a glance that the "bumi_malay" group forms the majority, followed by the "chinese" group.
                    </p>
                </div>
				<div class="col-12 col-sm-6 col-md-6 card p-4 chart-container">
					<div id="chart-ethnicity" style="height: 40vh;"></div>
				</div>


				<!-- 第三行: 两图并排 + 下方文字说明，style=text-align两端对齐 -->

				<div class="col-12 col-sm-6 col-md-6 card p-4 chart-container">
					<div id="chart-sex" style="height: 40vh;"></div>
				</div>
				<div class="col-12 col-sm-6 col-md-6 card p-4 chart-container">
					<div id="population-pyramid" style="height: 40vh;"></div>
				</div>
				
				<div class="col-12 col-sm-12 col-md-12 card p-4"style="text-align: justify;">
					<h3>Bar Chart & Pyramid</h3>
					<hr>
					<p>
						Two charts jointly analyze Malaysia's gender structure in 2024.
					</p>
					<p>
						The bar chart indicates that in 2024, Malaysia's total male population slightly exceeds the total female population.
						And the pyramid clearly shows that the male population advantage is concentrated primarily in the young and middle-aged segments (roughly from 0 to 50 years old). Within these age groups, the orange bars representing males are generally slightly longer than the blue bars representing females.
In the older age brackets (such as those aged 65 and above), the situation reverses. Due to women's typically longer average lifespans, the blue bars representing women begin to exceed the length of the male bars, indicating a greater number of women among the elderly population.
The pyramid's overall shape—broad in the middle, stable at the base, and narrowing at the top—reveals Malaysia's substantial working-age population (concentrated between 20 and 44 years old), representing a “demographic dividend” for current economic development. Simultaneously, it foreshadows the aging challenges society will face as this large cohort gradually transitions into old age.
					</p>
				</div>
				
            </div>
        </div>
    </div>

    <footer>
        <p>
            Created by: Wenjing Xu (Student ID: 35806532)
        </p>
        <p>
            Data Source: <a href="https://open.dosm.gov.my/data-catalogue/population_district" target="_blank">
                https://open.dosm.gov.my/data-catalogue/population_district</a>
        </p>
    </footer>

    <script>
        const spec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "width": "container",
            "autosize": {
                "type": "fit",
                "contains": "padding"
            },
            "height": 520,
            "background": "transparent",
            "params": [{ //定义三个下拉菜单(sex,age,ethnicity)
                "name": "sexParam",
                "value": "both",
                "bind": {
                    "input": "select",
                    "name": "Sex: ",
                    "options": ["both", "male", "female"]
                }
            }, {
                "name": "ageParam",
                "value": "overall",
                "bind": {
                    "input": "select",
                    "name": "Age: ",
                    "options": ["overall", "0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"]
                }
            }, {
                "name": "ethnicityParam",
                "value": "overall",
                "bind": {
                    "input": "select",
                    "name": "Ethnicity: ",
                    "options": ["overall", "bumi_malay", "bumi_other", "chinese", "indian", "other_citizen", "other_noncitizen"]
                }
            }],
            "data": {
                "url": "https://raw.githubusercontent.com/windy27182818/FIT3179/refs/heads/main/population_district_data.json"
            },
            "layer": [{
                "data": {
                    "url": "https://raw.githubusercontent.com/windy27182818/FIT3179/refs/heads/main/malaysia.district.json",
                    "format": {
                        "type": "topojson",
                        "feature": "malaysia.district"
                    }
                },
                "mark": {
                    "type": "geoshape",
                    "stroke": "white",
                    "strokeWidth": 0.5
                },
                "encoding": {
                    "color": {
                        "value": "rgba(0,0,0,0.1)"
                    }
                }
            }, {
                "transform": [{
                    "lookup": "id",
                    "from": {
                        "data": {
                            "url": "https://raw.githubusercontent.com/windy27182818/FIT3179/refs/heads/main/malaysia.district.json",
                            "format": {
                                "type": "topojson",
                                "feature": "malaysia.district"
                            }
                        },
                        "key": "id"
                    },
                    "as": "geo"
                }, {
                    "filter": "datum.sex == sexParam && datum.age == ageParam && datum.ethnicity == ethnicityParam && datum.population != 0"
                }],
                "projection": {
                    "type": "mercator"
                },
                "mark": {
                    "type": "geoshape",
                    "stroke": "#ffffff",
                    "strokeWidth": 0.5
                },
                "encoding": {
                    "shape": {
                        "field": "geo",
                        "type": "geojson"
                    },
                    "color": {
                        "condition": {
                            "test": "isValid(datum.population)",
                            "field": "population",
                            "type": "quantitative",
                            "scale": {
                                "scheme": "reds"
                                //"range": ["lightgray", "#ff7f0e", "#1f77b4"]
                            },
                            "legend": {
                                "title": "Population",
                                "orient": "right",
                                "direction": "vertical",
                                "gradientLength": 500,
                                "labelBaseline": "middle",
                                "titleAlign": "center"
                            }
                        },
                        "value": "#d6e6ff"
                    },
                    "tooltip": [{
                        "field": "district",
                        "type": "nominal",
                        "title": "District"
                    }, {
                        "field": "population",
                        "type": "quantitative",
                        "title": "Population"
                    }, {
                        "field": "date",
                        "type": "nominal",
                        "title": "Date"
                    }, {
                        "field": "sex",
                        "type": "nominal",
                        "title": "Sex"
                    }, {
                        "field": "age",
                        "type": "nominal",
                        "title": "Age"
                    }, {
                        "field": "ethnicity",
                        "type": "nominal",
                        "title": "Ethnicity"
                    }]
                }
            }]
        };

        vegaEmbed('#vis', spec, {
            actions: true
        }).then(function(result) {
            const view = result.view;

            view.addSignalListener('sexParam', function(name, value) {
                console.log('Sex parameter changed to:', value);
                outputFilteredData(view);
            });

            view.addSignalListener('ageParam', function(name, value) {
                console.log('Age parameter changed to:', value);
                outputFilteredData(view);
            });

            view.addSignalListener('ethnicityParam', function(name, value) {
                console.log('Ethnicity parameter changed to:', value);
                outputFilteredData(view);
            });

            outputFilteredData(view);
        });

        function outputFilteredData(view) {
            view.runAsync().then(function() {
                const data = view.data('source_0');
                console.log('Filtered data count:', data.length);
                console.log('Filtered data:', data);

                const statsDiv = document.getElementById('data-stats');
                statsDiv.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold;">Filter Result</div>
                    <hr>
                    <div>➡️Current data rows: ${data.length}</div>
                    <div>➡️Current input params: sex=${view.signal('sexParam')}, age=${view.signal('ageParam')}, ethnicity=${view.signal('ethnicityParam')}</div>
                    <hr>
                    <details>
                        <summary>Data detail</summary>
                        <pre>${JSON.stringify(data.slice(0, 10), null, 2)}${data.length > 10 ? '\n... (Only preview the first 10 rows of data)' : ''}</pre>
                    </details>
                `;
            });
        }

        // Static Dashboard Charts
        const dataUrl = 'https://raw.githubusercontent.com/windy27182818/FIT3179/refs/heads/main/population_district_data.json';
        const chartConfig = {
            actions: false
        };

        // Stacked Bar Chart
        const specStackedBar = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "title": "Ethnic Composition by State (2024)",
            "width": "container",
			"height": "container",
			"background": "transparent",
			"autosize": {
                "type": "fit",
                "contains": "padding"
            },
            "data": {
                "url": dataUrl
            },
            "transform": [{
                    "filter": "datum.sex == 'both' && datum.age == 'overall' && datum.ethnicity != 'overall'"
                },
                {
                    "aggregate": [{
                        "op": "sum",
                        "field": "population",
                        "as": "total_population"
                    }],
                    "groupby": ["state", "ethnicity"]
                }
            ],
            "mark": "bar",
            "encoding": {
                "y": {
                    "field": "state",
                    "type": "nominal",
                    "title": "State",
                    "sort": "-x"
                },
                "x": {
                    "field": "total_population",
                    "type": "quantitative",
                    "title": "Population (in thousands)"
                },
                "color": {
                    "field": "ethnicity",
                    "type": "nominal",
                    "title": "Ethnicity",
                    "scale": {
                        "scheme": "pastel1"
                    }
                },
                "tooltip": [{
                        "field": "state",
                        "type": "nominal"
                    },
                    {
                        "field": "ethnicity",
                        "type": "nominal"
                    },
                    {
                        "field": "total_population",
                        "type": "quantitative",
                        "title": "Population",
                        "format": ",.1f"
                    }
                ]
            }
        };
        vegaEmbed('#stacked-bar-chart', specStackedBar, {
            actions: false
        });

        // Population by Ethnicity
        const specEthnicity = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "title": "Population by Ethnicity (2024)",
            "width": "container",
			"height": "container",
			"background": "transparent",
			"autosize": {
                "type": "fit",
                "contains": "padding"
            },
            "data": {
                "url": dataUrl
            },
            "transform": [{
                    "filter": "datum.sex == 'both' && datum.age == 'overall' && datum.ethnicity != 'overall'"
                }, //排除 ethnicity 字段为 'overall' 的总计行,从而只保留具体的种族分类数据用于可视化
                {
                    "aggregate": [{
                        "op": "sum",
                        "field": "population",
                        "as": "total_population"
                    }],
                    "groupby": ["ethnicity"]
                }
            ],
            "mark": {
                "type": "arc",
                "innerRadius": 50
            }, //arc弧形,innerRadius设置内半径形成环形
            "encoding": {
                "theta": {
                    "field": "total_population",
                    "type": "quantitative",
                    "stack": true
                },
                "color": {
                    "field": "ethnicity",
                    "type": "nominal",
                    "title": "Ethnicity",
                    "scale": {
                        "scheme": "pastel1"
                    } //set3也是浅色系
                },
                //field:ethnicity, 表示每个不同的种族(ethnicity)类别将被映射到不同的颜色, type:nominal分配离散的颜色
                "tooltip": [{
                        "field": "ethnicity",
                        "type": "nominal"
                    },
                    {
                        "field": "total_population",
                        "type": "quantitative",
                        "title": "Population (thousands)",
                        "format": ",.1f"
                    }
                ]
            }
        };
        vegaEmbed('#chart-ethnicity', specEthnicity, chartConfig);

        // Population by Sex
        const specSex = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "title": "Population by Sex (2024)",
            "width": "container",
			"height": "container",
			"background": "transparent",
			"autosize": {
                "type": "fit",
                "contains": "padding"
            },
            "data": {
                "url": dataUrl
            },
            "transform": [{
                    "filter": "datum.age == 'overall' && datum.ethnicity == 'overall' && (datum.sex == 'male' || datum.sex == 'female')"
                },
                {
                    "aggregate": [{
                        "op": "sum",
                        "field": "population",
                        "as": "total_population"
                    }],
                    "groupby": ["sex"]
                }
            ],
            "mark": "bar",
            "encoding": {
                "x": {
                    "field": "sex",
                    "type": "nominal",
                    "title": "Sex",
                    "axis": {
                        "labelAngle": 0
                    },
                    "sort": ["male", "female"]
                },
                "y": {
                    "field": "total_population",
                    "type": "quantitative",
                    "title": "Population (in thousands)"
                },
                "color": {
                    "field": "sex",
                    "type": "nominal",
                    "legend": null
                },
                "tooltip": [{
                        "field": "sex",
                        "type": "nominal"
                    },
                    {
                        "field": "total_population",
                        "type": "quantitative",
                        "title": "Population (thousands)",
                        "format": ",.1f"
                    }
                ]
            }
        };
        vegaEmbed('#chart-sex', specSex, chartConfig);

        // Population Pyramid
        const specPyramid = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "title": "Malaysia Population Pyramid (2024)",
            "width": "container",
			"height": "container",
			"background": "transparent",
			"autosize": {
                "type": "fit",
                "contains": "padding"
            },
            "data": {
                "url": dataUrl
            },
            "transform": [{
                    "filter": "(datum.sex == 'female' || datum.sex == 'male') && datum.age != 'overall' && datum.ethnicity == 'overall'"
                },
                {
                    "aggregate": [{
                        "op": "sum",
                        "field": "population",
                        "as": "total_population"
                    }],
                    "groupby": ["sex", "age"]
                },
                {
                    "calculate": "datum.sex == 'male' ? -datum.total_population : datum.total_population",
                    "as": "signed_population"
                }
            ],
            "mark": "bar",
            "encoding": {
                "y": {
                    "field": "age",
                    "type": "ordinal",
                    "title": "Age Group",
                    "sort": ["0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"],
                    "axis": {
                        "title": null
                    }
                },
                "x": {
                    "field": "signed_population",
                    "type": "quantitative",
                    "title": "Population (in thousands)",
                    "axis": {
                        "labelExpr": "abs(datum.value)"
                    }
                },
                "color": {
                    "field": "sex",
                    "type": "nominal",
                    "title": "Sex",
                    "scale": {
                        "range": ["#1f77b4", "#ff7f0e"]
                    }
                },
                "tooltip": [{
                        "field": "age",
                        "type": "nominal",
                        "title": "Age Group"
                    },
                    {
                        "field": "sex",
                        "type": "nominal",
                        "title": "Sex"
                    },
                    {
                        "field": "total_population",
                        "type": "quantitative",
                        "title": "Population",
                        "format": ",.0f"
                    }
                ]
            }
        };

        vegaEmbed('#population-pyramid', specPyramid, {
            actions: false
        });
    </script>
</body>

</html>